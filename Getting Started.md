[Home](https://bitbucket.org/sibanez/netfpga-sume-sdnet/wiki/Home)
------

---

Getting Started Guide
=====================

---

Steps for initial setup:
------------------------

1. Go to the [NetFPGA SUME System Setup](https://github.com/NetFPGA/NetFPGA-SUME-public/wiki/Reference-Operating-System-Setup-Guide) wiki page and follow the instructions. Make sure to install all of the required dependencies. 

    * **Important**: This project uses **Vivado 2016.4**. You will likely run into issues if you do not use this version of Vivado. Also, make sure to check the box indicating that you would like to install the SDK when installing Vivado.

2. Install the Xilinx P4-SDNet tools.

3. Clone this repository:

    `$ git clone <repo-link> NetFPGA-SUME-SDNet`

4. Update environment variables:

    * Edit `NetFPGA-SUME-SDNet/tools/settings.sh`. Update `SUME_FOLDER` to point to the installation location of the repo. Update `P4_PROJECT_NAME` to the name of the project you wish to work on.

5. Build the SUME hardware library cores and some SW to access registers:

    `$ cd $SUME_FOLDER/lib/hw/xilinx/cores/tcam_v1_1_0/ && make update && make`

    `$ cd $SUME_FOLDER/lib/hw/xilinx/cores/cam_v1_1_0/ && make update && make`

    `$ cd $SUME_FOLDER && make`

    `$ cd $SUME_SDNET/sw/sume && make`

6. Build and load the SUME drivers:

```
    [root@nf-test109 ~]# cd $DRIVER_FOLDER
    [root@nf-test109 sume_riffa_v1_0_0]# make all
    [root@nf-test109 sume_riffa_v1_0_0]# make install
    [root@nf-test109 sume_riffa_v1_0_0]# modprobe sume_riffa
    [root@nf-test109 sume_riffa_v1_0_0]# lsmod sume_riffa
```

---

Environment Variables
---------------------

The `NetFPGA-SUME-SDNet/tools/settings.sh` script exports all of the environment
variables used for the project. Here are some of the important ones:

* `$P4_PROJECT_NAME` - The name of the P4 project currently being used. This name
is used to identify both the name of the P4 project directory as well as the top
level P4 source file.

* `$NF_PROJECT_NAME` - The name of the SUME project directory that contains all of
the files pertaining to testing and HDL development for the SUME platform. Currently,
the only supported target is simple_sume_switch. Each P4 project should have its
own local copy of simple_sume_switch.

* `$SUME_FOLDER` - This should be set to the installation location of the
NetFPGA-SUME-SDNet repository. This is the top level folder that corresponds to
the NetFPGA-SUME-live folder.

* `$SUME-SDNET` - This is the main directory of the project that contains all of the
scripts, templates, and tools that are used in the workflow. It also contains all
of the P4 projects. It is located in NetFPGA-SUME-SDNet/contrib-projects/

* `$P4_PROJECT_DIR` - Identifies the directory of the current P4 project being used.

* `$NF_DESIGN_DIR` - Identifies the directory of the local simple_sume_switch

These environment variables can be used to easily navigate the directory structure.

---

P4_PROJECT_DIR Directory Description
------------------------------------
```
${P4_PROJECT_DIR}
|-- src: contains the P4 source files and the commands.txt file
|-- testdata: contains the gen_testdata.py script
|-- sw: contains various software that is generated by the tools
|   |-- API: contains the CAM API generated by SDNet for interacting with the
|   |        tables in the P4 program. Also contains a sample C file with starter
|   |        code that can be used as a starting point for writing a C-based
|   |        control-plane for the switch.
|   |-- CLI: run $ ./P4_SWITCH_CLI.py to start up an interactive command line tool
|   |        that can be used to query compile time information about the generated
|   |        design, as well as interact with the physical switch on the FPGA (i.e.
|   |        read/write registers, add/remove table entries, etc.)
|-- simple_sume_switch: the SUME project that contains SUME simulation infrastructure
|       as well as some source HDL files.
|-- nf_sume_sdnet_ip: the directory that is created by SDNet. It contains all of the
|       verilog files and a testbench that can be used for initial verification.
```

---

Tips:
-----

* **Creating a New P4 Project:** Run the following command when you would like to create a new P4 project. It will create a template project in `$SUME_SDNET/projects/` to get you up and running quickly.

    `$ $SUME_SDNET/bin/make_new_p4_proj.py <P4_PROJECT_NAME>`

* **Environment Setup:** It is recommended that users add the following lines to their ~/.bashrc file
(adjusted to use your specific paths):

```
##### Vivado #####
source /opt/Xilinx/Vivado/2016.4/settings64.sh

#### P4-NetFPGA #####
source ~/projects/NetFPGA-SUME-SDNet/tools/settings.sh

#### SDNet ####
export PATH=/opt/Xilinx/SDNet/2017.1/bin:$PATH
source /opt/Xilinx/SDNet/2017.1/settings64.sh

# point to Vivado license file and SDNet license file
export XILINXD_LICENSE_FILE= ... 
export LM_LICENSE_FILE= ... 
```

* Review the reference projects in `$SUME_SDNET/projects/` and go through the [tutorial assignments](https://bitbucket.org/sibanez/netfpga-sume-sdnet/wiki/Tutorial%20Assignments).